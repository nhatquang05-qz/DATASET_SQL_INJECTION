import requests
import json

class DVWAPentestTool:
    def __init__(self, base_url, username, password):
        self.base_url = base_url.rstrip('/')
        self.session = requests.Session()
        self.login(username, password)

    def login(self, username, password):
        """Đăng nhập vào DVWA để lấy session."""
        login_url = f"{self.base_url}/login.php"
        data = {
            'username': username,
            'password': password,
            'login': 'Login'
        }
        try:
            resp = self.session.post(login_url, data=data, timeout=10)
            if "login" in resp.url or resp.status_code != 200:
                print("[!] Đăng nhập DVWA thất bại.")
            else:
                print("[+] Đăng nhập DVWA thành công.")
        except Exception as e:
            print(f"[!] Lỗi khi đăng nhập: {e}")

    def test_sqli_get(self, payloads):
        """
        Thử SQL Injection (GET) tại endpoint /vulnerabilities/sqli/
        với tham số 'id'. Ghi log kết quả.
        """
        vuln_path = "/vulnerabilities/sqli/"
        url = self.base_url + vuln_path

        for item in payloads:
            payload = item["payload"]
            params = {'id': f"1{payload}", 'Submit': 'Submit'}
            print(f"\n[*] Thử payload: {payload}")
            print(f"    - Kỹ thuật: {item.get('technique')}")
            print(f"    - Mục đích: {item.get('purpose')}")
            print(f"    - Mức độ: {item.get('severity')}")
            print(f"    - Mô tả: {item.get('description')}")

            try:
                resp = self.session.get(url, params=params, timeout=10)
                if resp.status_code == 200:
                    content = resp.text.lower()
                    if "user" in content or "password" in content:
                        print("  ==> [!] Có thể thành công (phát hiện từ khóa 'user' hoặc 'password').")
                    else:
                        print("  ==> [-] Không phát hiện dữ liệu nghi ngờ.")
                else:
                    print(f"  ==> [!] HTTP {resp.status_code}")
            except Exception as e:
                print(f"  ==> [!] Lỗi khi gửi payload: {e}")

def load_payloads_from_json(json_path):
    try:
        with open(json_path, 'r', encoding='utf-8') as f:
            return json.load(f)
    except Exception as e:
        print(f"[!] Lỗi khi đọc file JSON: {e}")
        return []

# === Sử dụng công cụ ===
json_file_path = "output/dvwa_demo.json"  # Thay bằng đường dẫn thực tế của bạn
payloads = load_payloads_from_json(json_file_path)

dvwa = DVWAPentestTool("http://localhost/dvwa", "admin", "password")
dvwa.test_sqli_get(payloads)
